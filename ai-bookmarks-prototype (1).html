<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Bookmarks - Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap');
    
    body { font-family: 'Inter', sans-serif; }
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    .vscode-bg { background: #1e1e1e; }
    .vscode-sidebar { background: #252526; }
    .vscode-border { border-color: #3c3c3c; }
    .vscode-text { color: #cccccc; }
    .vscode-text-dim { color: #858585; }
    .vscode-accent { color: #569cd6; }
    .vscode-hover { background: #2a2d2e; }
    
    .flow-line {
      position: absolute;
      left: 19px;
      top: 24px;
      bottom: -8px;
      width: 2px;
      background: linear-gradient(to bottom, #569cd6, #569cd6 50%, transparent);
    }
    
    .bookmark-card {
      transition: all 0.15s ease;
    }
    .bookmark-card:hover {
      background: #2a2d2e;
    }
    
    .category-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .group-header {
      background: linear-gradient(90deg, #569cd620, transparent);
      border-left: 3px solid #569cd6;
    }
  </style>
</head>
<body class="vscode-bg min-h-screen">
  <div class="flex h-screen">
    <!-- 側邊欄 - 書籤面板 -->
    <div class="w-80 vscode-sidebar border-r vscode-border flex flex-col">
      <!-- 標題欄 -->
      <div class="p-3 border-b vscode-border flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="bookmark" class="w-4 h-4 text-blue-400"></i>
          <span class="text-sm font-medium vscode-text">AI BOOKMARKS</span>
        </div>
        <div class="flex gap-1">
          <button class="p-1 rounded hover:bg-white/10" title="新增分組">
            <i data-lucide="folder-plus" class="w-4 h-4 vscode-text-dim"></i>
          </button>
          <button class="p-1 rounded hover:bg-white/10" title="刷新">
            <i data-lucide="refresh-cw" class="w-4 h-4 vscode-text-dim"></i>
          </button>
          <button class="p-1 rounded hover:bg-white/10" title="導出">
            <i data-lucide="download" class="w-4 h-4 vscode-text-dim"></i>
          </button>
        </div>
      </div>
      
      <!-- 搜索欄 -->
      <div class="p-2 border-b vscode-border">
        <div class="relative">
          <i data-lucide="search" class="w-4 h-4 vscode-text-dim absolute left-2 top-1/2 -translate-y-1/2"></i>
          <input type="text" placeholder="搜索書籤..." 
            class="w-full bg-[#3c3c3c] text-sm vscode-text rounded px-8 py-1.5 outline-none focus:ring-1 focus:ring-blue-500">
        </div>
      </div>
      
      <!-- 書籤列表 -->
      <div class="flex-1 overflow-auto p-2" id="bookmark-list">
        <!-- 分組會動態渲染這裡 -->
      </div>
    </div>
    
    <!-- 主內容區 - 模擬編輯器 -->
    <div class="flex-1 flex flex-col">
      <!-- Tab 欄 -->
      <div class="h-9 vscode-sidebar border-b vscode-border flex items-center px-2">
        <div class="flex items-center gap-2 px-3 py-1 bg-[#1e1e1e] border-t-2 border-blue-500 text-sm vscode-text">
          <i data-lucide="file-code" class="w-4 h-4"></i>
          <span class="mono">src/game/crash.go</span>
          <button class="ml-2 hover:bg-white/10 rounded p-0.5">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </div>
      </div>
      
      <!-- 編輯器區域 -->
      <div class="flex-1 flex">
        <!-- 行號 + Gutter -->
        <div class="w-16 vscode-sidebar border-r vscode-border flex flex-col mono text-xs">
          <div id="line-numbers" class="flex-1">
            <!-- 行號動態渲染 -->
          </div>
        </div>
        
        <!-- 代碼區 -->
        <div class="flex-1 p-4 overflow-auto">
          <pre class="mono text-sm vscode-text leading-6" id="code-content">
<!-- 代碼動態渲染 -->
          </pre>
        </div>
        
        <!-- 書籤詳情面板 -->
        <div class="w-96 vscode-sidebar border-l vscode-border p-4 overflow-auto" id="detail-panel">
          <div class="text-center vscode-text-dim py-8">
            <i data-lucide="mouse-pointer-click" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
            <p class="text-sm">點擊書籤查看詳情</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 示例數據 - 新的數據結構
    const bookmarkData = {
      version: 1,
      groups: [
        {
          id: "grp-001",
          name: "Crash 遊戲核心流程",
          description: "AI 分析的遊戲主循環和關鍵節點",
          createdAt: "2024-01-15T10:30:00Z",
          createdBy: "ai",
          query: "幫我理解 crash 遊戲的核心邏輯流程",
          bookmarks: [
            {
              id: "bm-001",
              order: 1,
              location: "src/game/crash.go:45",
              title: "遊戲初始化",
              description: "創建遊戲實例，初始化 multiplier 為 1.0，設置遊戲狀態為 waiting",
              category: "entry-point",
              tags: ["init", "game-loop"]
            },
            {
              id: "bm-002", 
              order: 2,
              location: "src/game/crash.go:78-92",
              title: "下注階段處理",
              description: "收集玩家下注，驗證餘額，記錄下注時間。這個階段持續 10 秒。",
              category: "core-logic",
              tags: ["betting", "validation"]
            },
            {
              id: "bm-003",
              order: 3,
              location: "src/game/crash.go:105",
              title: "生成 Crash Point",
              description: "使用 provably fair 算法生成本局的 crash 點位。算法：hash(server_seed + client_seed + nonce)",
              category: "core-logic",
              tags: ["random", "provably-fair", "critical"]
            },
            {
              id: "bm-004",
              order: 4,
              location: "src/game/crash.go:142-180",
              title: "Multiplier 遞增循環",
              description: "每 100ms 更新一次 multiplier，公式：1.0 * (1.0024 ^ elapsed_ms)。同時檢查是否有玩家 cash out。",
              category: "core-logic",
              tags: ["game-loop", "multiplier"]
            },
            {
              id: "bm-005",
              order: 5,
              location: "src/game/crash.go:195",
              title: "Crash 結算",
              description: "當 multiplier >= crashPoint 時觸發。未 cash out 的玩家輸掉下注，已 cash out 的按其倍率結算。",
              category: "core-logic",
              tags: ["settlement", "payout"]
            }
          ]
        },
        {
          id: "grp-002",
          name: "待優化項",
          description: "Code review 發現的問題",
          createdAt: "2024-01-15T11:00:00Z",
          createdBy: "ai",
          query: "review 這段代碼，找出潛在問題",
          bookmarks: [
            {
              id: "bm-006",
              order: 1,
              location: "src/game/crash.go:156",
              title: "精度問題",
              description: "float64 計算 multiplier 可能有精度累積誤差，建議使用 decimal 庫或整數運算",
              category: "optimization",
              tags: ["precision", "math"]
            },
            {
              id: "bm-007",
              order: 2,
              location: "src/game/crash.go:203-210",
              title: "並發安全",
              description: "結算時遍歷玩家 map 沒有加鎖，可能導致 concurrent map iteration and map write",
              category: "bug",
              tags: ["concurrency", "critical"]
            }
          ]
        },
        {
          id: "grp-003",
          name: "手動標記",
          description: "自己添加的書籤",
          createdAt: "2024-01-14T09:00:00Z",
          createdBy: "user",
          bookmarks: [
            {
              id: "bm-008",
              order: 1,
              location: "src/game/crash.go:1",
              title: "TODO: 添加單元測試",
              description: "這個文件還沒有測試覆蓋",
              category: "todo",
              tags: ["testing"]
            }
          ]
        }
      ]
    };

    // 示例代碼
    const sampleCode = `package game

import (
    "context"
    "math"
    "sync"
    "time"
    
    "github.com/google/uuid"
)

type GameState string

const (
    StateWaiting  GameState = "waiting"
    StateBetting  GameState = "betting"
    StateRunning  GameState = "running"
    StateCrashed  GameState = "crashed"
)

type Player struct {
    ID       string
    BetAmount float64
    CashOutAt float64
    HasCashedOut bool
}

type CrashGame struct {
    ID          string
    State       GameState
    Multiplier  float64
    CrashPoint  float64
    Players     map[string]*Player
    StartTime   time.Time
    mu          sync.RWMutex
}

// NewCrashGame 創建新遊戲實例
func NewCrashGame() *CrashGame {                    // ← 書籤 1: 遊戲初始化
    return &CrashGame{
        ID:         uuid.New().String(),
        State:      StateWaiting,
        Multiplier: 1.0,
        Players:    make(map[string]*Player),
    }
}

// PlaceBet 處理玩家下注
func (g *CrashGame) PlaceBet(playerID string, amount float64) error {
    g.mu.Lock()
    defer g.mu.Unlock()
    
    if g.State != StateBetting {
        return ErrNotBettingPhase
    }
    
    // 驗證下注金額
    if amount < MinBet || amount > MaxBet {
        return ErrInvalidBetAmount
    }
    
    g.Players[playerID] = &Player{
        ID:        playerID,
        BetAmount: amount,
    }
    
    return nil
}

// StartBetting 開始下注階段
func (g *CrashGame) StartBetting(ctx context.Context) {  // ← 書籤 2: 下注階段
    g.State = StateBetting
    
    // 下注階段持續 10 秒
    select {
    case <-time.After(10 * time.Second):
        g.startGame(ctx)
    case <-ctx.Done():
        return
    }
}

// generateCrashPoint 生成 crash 點位
func (g *CrashGame) generateCrashPoint() float64 {   // ← 書籤 3: Crash Point
    // Provably fair 算法
    hash := sha256(g.ServerSeed + g.ClientSeed + g.Nonce)
    
    // 轉換為 crash point (house edge 3%)
    h := float64(hashToInt(hash))
    e := math.Pow(2, 52)
    
    return math.Max(1.0, (100*e-h)/(e-h)) * 0.97
}

// startGame 開始遊戲主循環
func (g *CrashGame) startGame(ctx context.Context) {
    g.CrashPoint = g.generateCrashPoint()
    g.State = StateRunning
    g.StartTime = time.Now()
    
    ticker := time.NewTicker(100 * time.Millisecond)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            g.updateMultiplier()                     // ← 書籤 4: Multiplier 遞增
            
            if g.Multiplier >= g.CrashPoint {
                g.crash()                            // ← 書籤 5: Crash 結算
                return
            }
            
            g.broadcastState()
            
        case <-ctx.Done():
            return
        }
    }
}

// updateMultiplier 更新倍率
func (g *CrashGame) updateMultiplier() {
    elapsed := time.Since(g.StartTime).Milliseconds()
    g.Multiplier = math.Pow(1.0024, float64(elapsed))  // ← 書籤 6: 精度問題
}

// crash 處理遊戲結束
func (g *CrashGame) crash() {
    g.State = StateCrashed
    
    // 結算所有玩家                                    // ← 書籤 7: 並發安全
    for _, player := range g.Players {
        if player.HasCashedOut {
            payout := player.BetAmount * player.CashOutAt
            // 發放獎勵...
        }
        // 未 cash out 的玩家輸掉下注
    }
    
    g.broadcastResult()
}

// CashOut 玩家提前離場
func (g *CrashGame) CashOut(playerID string) error {
    g.mu.Lock()
    defer g.mu.Unlock()
    
    if g.State != StateRunning {
        return ErrGameNotRunning
    }
    
    player, ok := g.Players[playerID]
    if !ok {
        return ErrPlayerNotFound
    }
    
    if player.HasCashedOut {
        return ErrAlreadyCashedOut
    }
    
    player.HasCashedOut = true
    player.CashOutAt = g.Multiplier
    
    return nil
}`;

    // 解析 location 格式: /path/to/file:45 或 /path/to/file:78-92
    function parseLocation(location) {
      const lastColon = location.lastIndexOf(':');
      const filePath = location.substring(0, lastColon);
      const lineRange = location.substring(lastColon + 1);
      
      let lineStart, lineEnd;
      if (lineRange.includes('-')) {
        [lineStart, lineEnd] = lineRange.split('-').map(n => parseInt(n));
      } else {
        lineStart = parseInt(lineRange);
        lineEnd = lineStart;
      }
      
      return { filePath, lineStart, lineEnd };
    }

    // 獲取分類顏色
    function getCategoryColor(category) {
      const colors = {
        'entry-point': 'bg-green-500/20 text-green-400',
        'core-logic': 'bg-blue-500/20 text-blue-400',
        'todo': 'bg-yellow-500/20 text-yellow-400',
        'bug': 'bg-red-500/20 text-red-400',
        'optimization': 'bg-orange-500/20 text-orange-400',
        'explanation': 'bg-purple-500/20 text-purple-400',
        'warning': 'bg-amber-500/20 text-amber-400',
        'reference': 'bg-gray-500/20 text-gray-400'
      };
      return colors[category] || 'bg-gray-500/20 text-gray-400';
    }

    // 獲取分類圖標
    function getCategoryIcon(category) {
      const icons = {
        'entry-point': 'play',
        'core-logic': 'cpu',
        'todo': 'check-square',
        'bug': 'bug',
        'optimization': 'zap',
        'explanation': 'message-square',
        'warning': 'alert-triangle',
        'reference': 'link'
      };
      return icons[category] || 'bookmark';
    }

    // 渲染書籤列表
    function renderBookmarkList() {
      const container = document.getElementById('bookmark-list');
      container.innerHTML = '';
      
      bookmarkData.groups.forEach(group => {
        const groupEl = document.createElement('div');
        groupEl.className = 'mb-4';
        groupEl.innerHTML = `
          <div class="group-header px-2 py-1.5 mb-1 rounded-r cursor-pointer hover:bg-white/5">
            <div class="flex items-center gap-2">
              <i data-lucide="chevron-down" class="w-3 h-3 vscode-text-dim"></i>
              <i data-lucide="folder" class="w-4 h-4 text-blue-400"></i>
              <span class="text-sm font-medium vscode-text flex-1">${group.name}</span>
              <span class="text-xs vscode-text-dim">${group.bookmarks.length}</span>
            </div>
            ${group.query ? `<div class="text-xs vscode-text-dim mt-1 ml-5 truncate" title="${group.query}">Q: ${group.query}</div>` : ''}
          </div>
          <div class="ml-2 space-y-0.5">
            ${group.bookmarks.map((bm, idx) => {
              const loc = parseLocation(bm.location);
              const isLast = idx === group.bookmarks.length - 1;
              return `
                <div class="bookmark-card relative pl-6 pr-2 py-1.5 rounded cursor-pointer" 
                     data-bookmark-id="${bm.id}" data-group-id="${group.id}">
                  ${!isLast ? '<div class="flow-line"></div>' : ''}
                  <div class="absolute left-0 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-[#3c3c3c] flex items-center justify-center text-xs font-medium text-blue-400 z-10">
                    ${bm.order}
                  </div>
                  <div class="flex items-start gap-2">
                    <i data-lucide="${getCategoryIcon(bm.category)}" class="w-3.5 h-3.5 mt-0.5 ${getCategoryColor(bm.category).split(' ')[1]}"></i>
                    <div class="flex-1 min-w-0">
                      <div class="text-sm vscode-text truncate">${bm.title}</div>
                      <div class="mono text-xs vscode-text-dim">:${loc.lineStart}${loc.lineEnd !== loc.lineStart ? '-' + loc.lineEnd : ''}</div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        container.appendChild(groupEl);
      });
      
      lucide.createIcons();
      bindBookmarkClicks();
    }

    // 渲染行號
    function renderLineNumbers() {
      const container = document.getElementById('line-numbers');
      const lines = sampleCode.split('\n');
      const bookmarkedLines = new Set();
      
      // 收集所有書籤行
      bookmarkData.groups.forEach(group => {
        group.bookmarks.forEach(bm => {
          const loc = parseLocation(bm.location);
          for (let i = loc.lineStart; i <= loc.lineEnd; i++) {
            bookmarkedLines.add(i);
          }
        });
      });
      
      container.innerHTML = lines.map((_, idx) => {
        const lineNum = idx + 1;
        const hasBookmark = bookmarkedLines.has(lineNum);
        return `
          <div class="flex items-center h-6 px-2 ${hasBookmark ? 'bg-blue-500/10' : ''}">
            ${hasBookmark ? '<i data-lucide="bookmark" class="w-3 h-3 text-blue-400 mr-1"></i>' : '<span class="w-4"></span>'}
            <span class="vscode-text-dim text-right flex-1">${lineNum}</span>
          </div>
        `;
      }).join('');
      
      lucide.createIcons();
    }

    // 渲染代碼
    function renderCode() {
      const container = document.getElementById('code-content');
      const lines = sampleCode.split('\n');
      
      container.innerHTML = lines.map((line, idx) => {
        // 簡單的語法高亮
        let highlighted = line
          .replace(/\/\/.*/g, '<span class="text-green-600">$&</span>')
          .replace(/(".*?")/g, '<span class="text-orange-300">$1</span>')
          .replace(/\b(func|type|const|var|return|if|for|select|case|defer|package|import|struct|interface|map|make|range)\b/g, '<span class="text-pink-400">$1</span>')
          .replace(/\b(string|float64|bool|int|int64|error|time|context|sync)\b/g, '<span class="text-cyan-400">$1</span>');
        
        return `<div class="h-6">${highlighted || ' '}</div>`;
      }).join('');
    }

    // 顯示書籤詳情
    function showBookmarkDetail(bookmarkId, groupId) {
      const group = bookmarkData.groups.find(g => g.id === groupId);
      const bookmark = group.bookmarks.find(b => b.id === bookmarkId);
      const loc = parseLocation(bookmark.location);
      
      const panel = document.getElementById('detail-panel');
      panel.innerHTML = `
        <div class="space-y-4">
          <!-- 標題區 -->
          <div>
            <div class="flex items-center gap-2 mb-2">
              <span class="category-tag ${getCategoryColor(bookmark.category)}">${bookmark.category}</span>
              <span class="text-xs vscode-text-dim">步驟 ${bookmark.order}/${group.bookmarks.length}</span>
            </div>
            <h2 class="text-lg font-semibold vscode-text">${bookmark.title}</h2>
          </div>
          
          <!-- 位置 -->
          <div class="bg-[#3c3c3c] rounded p-2">
            <div class="mono text-sm text-blue-400">${bookmark.location}</div>
          </div>
          
          <!-- 說明 -->
          <div>
            <h3 class="text-xs font-medium vscode-text-dim uppercase mb-2">說明</h3>
            <p class="text-sm vscode-text leading-relaxed">${bookmark.description}</p>
          </div>
          
          <!-- 標籤 -->
          ${bookmark.tags?.length ? `
          <div>
            <h3 class="text-xs font-medium vscode-text-dim uppercase mb-2">標籤</h3>
            <div class="flex flex-wrap gap-1">
              ${bookmark.tags.map(tag => `<span class="px-2 py-0.5 bg-[#3c3c3c] rounded text-xs vscode-text">#${tag}</span>`).join('')}
            </div>
          </div>
          ` : ''}
          
          <!-- 所屬分組 -->
          <div class="pt-4 border-t vscode-border">
            <h3 class="text-xs font-medium vscode-text-dim uppercase mb-2">所屬分組</h3>
            <div class="bg-[#3c3c3c] rounded p-3">
              <div class="font-medium vscode-text text-sm">${group.name}</div>
              ${group.query ? `<div class="text-xs vscode-text-dim mt-1">問題: ${group.query}</div>` : ''}
            </div>
          </div>
          
          <!-- 流程導航 -->
          <div>
            <h3 class="text-xs font-medium vscode-text-dim uppercase mb-2">流程導航</h3>
            <div class="space-y-1">
              ${group.bookmarks.map(bm => `
                <div class="flex items-center gap-2 px-2 py-1 rounded cursor-pointer ${bm.id === bookmarkId ? 'bg-blue-500/20' : 'hover:bg-white/5'}"
                     onclick="showBookmarkDetail('${bm.id}', '${groupId}')">
                  <span class="w-5 h-5 rounded-full ${bm.id === bookmarkId ? 'bg-blue-500' : 'bg-[#3c3c3c]'} flex items-center justify-center text-xs font-medium ${bm.id === bookmarkId ? 'text-white' : 'text-blue-400'}">${bm.order}</span>
                  <span class="text-sm ${bm.id === bookmarkId ? 'text-blue-400' : 'vscode-text'} truncate">${bm.title}</span>
                </div>
              `).join('')}
            </div>
          </div>
          
          <!-- 操作按鈕 -->
          <div class="flex gap-2 pt-4">
            <button class="flex-1 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded flex items-center justify-center gap-1">
              <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
              跳轉
            </button>
            <button class="px-3 py-1.5 bg-[#3c3c3c] hover:bg-[#4c4c4c] vscode-text text-sm rounded">
              <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
            </button>
            <button class="px-3 py-1.5 bg-[#3c3c3c] hover:bg-[#4c4c4c] vscode-text text-sm rounded">
              <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
            </button>
          </div>
        </div>
      `;
      
      lucide.createIcons();
    }

    // 綁定點擊事件
    function bindBookmarkClicks() {
      document.querySelectorAll('.bookmark-card').forEach(card => {
        card.addEventListener('click', () => {
          const bookmarkId = card.dataset.bookmarkId;
          const groupId = card.dataset.groupId;
          showBookmarkDetail(bookmarkId, groupId);
          
          // 高亮選中
          document.querySelectorAll('.bookmark-card').forEach(c => c.classList.remove('bg-blue-500/10'));
          card.classList.add('bg-blue-500/10');
        });
      });
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      renderBookmarkList();
      renderLineNumbers();
      renderCode();
      lucide.createIcons();
    });
  </script>
</body>
</html>
